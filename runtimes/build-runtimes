#!/bin/bash
# Complete runtime packaging and manifest generation script
# Packages all runtimes and generates/updates runtime-manifest.json in one go

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Emoji-like symbols that work without unicode support
SUCCESS="âœ“"
ERROR="âœ—"  
WARNING="!"
INFO="Â»"
PACKAGE="ðŸ“¦"
BUILD="ðŸš€"
MANIFEST="ðŸ“"
SUMMARY="ðŸ“Š"

print_header() {
    echo -e "${CYAN}${BUILD} Joblet Runtime Builder${NC}"
    echo "=================================================="
    echo -e "${INFO} Building all runtime packages and manifest"
    echo
}

print_success() {
    echo -e "${GREEN}${SUCCESS} $1${NC}"
}

print_error() {
    echo -e "${RED}${ERROR} $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}${WARNING} $1${NC}"
}

print_info() {
    echo -e "${BLUE}${INFO} $1${NC}"
}

# Format file size in readable format
format_size() {
    local size=$1
    if [ $size -lt 1024 ]; then
        echo "${size}B"
    elif [ $size -lt 1048576 ]; then
        echo "$((size / 1024))KB"
    elif [ $size -lt 1073741824 ]; then
        echo "$((size / 1048576))MB"
    else
        echo "$((size / 1073741824))GB"
    fi
}

# Get file size in bytes
get_file_size() {
    local file="$1"
    if [ -f "$file" ]; then
        stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "0"
    else
        echo "0"
    fi
}

# Discover all runtimes by looking for directories with setup.sh
discover_runtimes() {
    local runtimes=()
    for dir in */; do
        local runtime_name="${dir%/}"
        if [ -f "$runtime_name/setup.sh" ]; then
            runtimes+=("$runtime_name")
        fi
    done
    printf '%s\n' "${runtimes[@]}" | sort
}

# Package a single runtime
package_runtime() {
    local runtime_name="$1"
    local archive_name="${runtime_name}.tar.gz"
    
    if [ ! -d "$runtime_name" ]; then
        print_warning "Directory ${runtime_name}/ not found, skipping"
        return 1
    fi
    
    if [ ! -f "$runtime_name/setup.sh" ]; then
        print_warning "No setup.sh found in ${runtime_name}/, skipping"
        return 1
    fi
    
    print_info "Packaging ${runtime_name}..."
    
    # Remove old archive if exists
    [ -f "$archive_name" ] && rm -f "$archive_name"
    
    # Create tar.gz archive
    if tar -czf "$archive_name" -C "$runtime_name" . 2>/dev/null; then
        local size=$(get_file_size "$archive_name")
        local size_str=$(format_size $size)
        print_success "Packaged: ${archive_name} (${size_str})"
        return 0
    else
        print_error "Failed to package ${runtime_name}"
        return 1
    fi
}

# Generate JSON manifest
generate_manifest() {
    local packaged_runtimes=("$@")
    
    print_info "Generating runtime manifest..."
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    
    # Start manifest JSON
    cat > runtime-manifest.json << EOF
{
  "version": "1.0.0",
  "generated": "$timestamp",
  "repository": "joblet/joblet",
  "base_url": "https://github.com/joblet/joblet/raw/main/runtimes",
  "runtimes": {
EOF

    local first_runtime=true
    local runtime_count=0
    
    # Add each runtime to manifest
    for runtime_name in "${packaged_runtimes[@]}"; do
        local archive_file="${runtime_name}.tar.gz"
        
        if [ ! -f "$archive_file" ]; then
            print_warning "Archive $archive_file not found, skipping manifest entry"
            continue
        fi
        
        local archive_size=$(get_file_size "$archive_file")
        local size_str=$(format_size $archive_size)
        
        # Add comma before each entry except the first
        if [ "$first_runtime" = false ]; then
            echo "," >> runtime-manifest.json
        else
            first_runtime=false
        fi
        
        print_info "Adding ${runtime_name} to manifest (${size_str})"
        
        # Generate runtime entry based on known runtimes
        case "$runtime_name" in
            "openjdk-21")
                cat >> runtime-manifest.json << OPENJDK_EOF
    "openjdk-21": {
      "name": "openjdk-21",
      "display_name": "OpenJDK 21",
      "version": "21.0.1",
      "description": "OpenJDK 21 with Java development tools and JVM runtime",
      "category": "language-runtime",
      "language": "java",
      "platforms": {
        "ubuntu-amd64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "ubuntu-arm64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "rhel-amd64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "rhel-arm64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "amzn-amd64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "amzn-arm64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" }
      },
      "requirements": { "min_ram_mb": 512, "min_disk_mb": 100, "gpu_required": false },
      "provides": {
        "executables": ["java", "javac", "jar", "jarsigner"],
        "environment_vars": { "JAVA_HOME": "/usr/lib/jvm/java-21-openjdk", "PATH": "/usr/lib/jvm/java-21-openjdk/bin:\$PATH" }
      },
      "documentation": {
        "usage": "Use with: rnx run --runtime=openjdk-21 java MyApp.java",
        "examples": ["rnx run --runtime=openjdk-21 java -version", "rnx run --runtime=openjdk-21 javac HelloWorld.java && java HelloWorld"]
      },
      "tags": ["java", "jdk", "openjdk", "development", "compilation"]
    }
OPENJDK_EOF
                ;;
            "graalvmjdk-21")
                cat >> runtime-manifest.json << GRAALVM_EOF
    "graalvmjdk-21": {
      "name": "graalvmjdk-21",
      "display_name": "GraalVM JDK 21",
      "version": "21.0.1",
      "description": "GraalVM Community Edition JDK 21 with native-image and polyglot support",
      "category": "language-runtime",
      "language": "java",
      "platforms": {
        "ubuntu-amd64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "ubuntu-arm64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "rhel-amd64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "rhel-arm64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "amzn-amd64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "amzn-arm64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" }
      },
      "requirements": { "min_ram_mb": 1024, "min_disk_mb": 200, "gpu_required": false },
      "provides": {
        "executables": ["java", "javac", "jar", "native-image", "gu"],
        "environment_vars": { "JAVA_HOME": "/usr/lib/jvm/graalvm-21", "GRAALVM_HOME": "/usr/lib/jvm/graalvm-21", "PATH": "/usr/lib/jvm/graalvm-21/bin:\$PATH" }
      },
      "documentation": {
        "usage": "Use with: rnx run --runtime=graalvmjdk-21 java MyApp.java or native-image",
        "examples": ["rnx run --runtime=graalvmjdk-21 java -version", "rnx run --runtime=graalvmjdk-21 native-image --version"]
      },
      "tags": ["java", "graalvm", "native-image", "performance", "aot"]
    }
GRAALVM_EOF
                ;;
            "python-3.11-ml")
                cat >> runtime-manifest.json << PYTHON_EOF
    "python-3.11-ml": {
      "name": "python-3.11-ml",
      "display_name": "Python 3.11 ML",
      "version": "3.11.7",
      "description": "Python 3.11 with machine learning libraries (NumPy, SciPy, Pandas, Scikit-learn)",
      "category": "language-runtime",
      "language": "python",
      "platforms": {
        "ubuntu-amd64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "ubuntu-arm64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "rhel-amd64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "rhel-arm64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "amzn-amd64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" },
        "amzn-arm64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" }
      },
      "requirements": { "min_ram_mb": 2048, "min_disk_mb": 500, "gpu_required": false },
      "provides": {
        "executables": ["python", "python3", "pip", "pip3"],
        "libraries": ["numpy", "scipy", "pandas", "scikit-learn", "matplotlib"],
        "environment_vars": { "PYTHON_PATH": "/usr/lib/python3.11", "PATH": "/usr/bin:\$PATH" }
      },
      "documentation": {
        "usage": "Use with: rnx run --runtime=python-3.11-ml python script.py",
        "examples": ["rnx run --runtime=python-3.11-ml python -c 'import numpy; print(numpy.__version__)'", "rnx run --runtime=python-3.11-ml python -c 'import pandas; print(pandas.__version__)'"]
      },
      "tags": ["python", "machine-learning", "data-science", "numpy", "pandas", "ml"]
    }
PYTHON_EOF
                ;;
            *)
                # Default for unknown runtimes
                print_warning "No config found for ${runtime_name}, using defaults"
                local display_name=$(echo "$runtime_name" | sed 's/-/ /g' | sed 's/\b\w/\U&/g')
                cat >> runtime-manifest.json << DEFAULT_EOF
    "$runtime_name": {
      "name": "$runtime_name",
      "display_name": "$display_name",
      "version": "1.0.0",
      "description": "Runtime environment for $runtime_name",
      "category": "language-runtime",
      "language": "unknown",
      "platforms": {
        "ubuntu-amd64": { "supported": true, "archive_url": "$archive_file", "archive_size": $archive_size, "checksum": "sha256:auto-generated" }
      },
      "requirements": { "min_ram_mb": 512, "min_disk_mb": 100, "gpu_required": false },
      "provides": { "executables": [], "environment_vars": {} },
      "documentation": { "usage": "Use with: rnx run --runtime=$runtime_name", "examples": [] },
      "tags": ["runtime"]
    }
DEFAULT_EOF
                ;;
        esac
        
        ((runtime_count++))
    done
    
    # Close JSON
    cat >> runtime-manifest.json << MANIFEST_EOF

  }
}
MANIFEST_EOF

    print_success "Generated manifest with $runtime_count runtimes"
    
    # Validate JSON if possible
    if command -v python3 >/dev/null 2>&1; then
        if python3 -m json.tool runtime-manifest.json >/dev/null 2>&1; then
            print_success "JSON validation passed"
        else
            print_error "JSON validation failed"
            return 1
        fi
    elif command -v node >/dev/null 2>&1; then
        if echo "JSON.parse(require('fs').readFileSync('runtime-manifest.json', 'utf8'))" | node >/dev/null 2>&1; then
            print_success "JSON validation passed"
        else
            print_error "JSON validation failed"
            return 1
        fi
    else
        print_warning "No JSON validator available (python3 or node), skipping validation"
    fi
    
    return 0
}

# Main function
main() {
    cd "$(dirname "$0")"
    
    print_header
    
    # Discover runtimes
    print_info "Discovering runtimes..."
    local runtimes=()
    while IFS= read -r runtime; do
        runtimes+=("$runtime")
    done < <(discover_runtimes)
    
    if [ ${#runtimes[@]} -eq 0 ]; then
        print_error "No runtimes found (looking for directories with setup.sh)"
        return 1
    fi
    
    echo "Found ${#runtimes[@]} runtimes to build:"
    for runtime in "${runtimes[@]}"; do
        echo "  â€¢ $runtime"
    done
    echo
    
    # Package all runtimes
    local packaged_runtimes=()
    local failed_runtimes=()
    
    for runtime in "${runtimes[@]}"; do
        if package_runtime "$runtime"; then
            packaged_runtimes+=("$runtime")
        else
            failed_runtimes+=("$runtime")
        fi
    done
    
    echo
    
    # Generate manifest for successfully packaged runtimes
    if [ ${#packaged_runtimes[@]} -gt 0 ]; then
        if ! generate_manifest "${packaged_runtimes[@]}"; then
            print_error "Failed to generate manifest"
            return 1
        fi
    else
        print_error "No runtimes were successfully packaged"
        return 1
    fi
    
    # Summary
    echo
    echo -e "${CYAN}${SUMMARY} Build Summary${NC}"
    echo "===================="
    print_success "Successfully built: ${#packaged_runtimes[@]} runtimes"
    
    if [ ${#failed_runtimes[@]} -gt 0 ]; then
        print_error "Failed to build: ${#failed_runtimes[@]} runtimes"
        for runtime in "${failed_runtimes[@]}"; do
            echo "  â€¢ $runtime"
        done
    fi
    
    echo
    echo -e "${PURPLE}${MANIFEST} Generated files:${NC}"
    # List all .tar.gz files with sizes
    for archive in *.tar.gz; do
        if [ -f "$archive" ]; then
            local size=$(get_file_size "$archive")
            local size_str=$(format_size $size)
            echo "  â€¢ $archive ($size_str)"
        fi
    done
    echo "  â€¢ runtime-manifest.json"
    
    if [ ${#failed_runtimes[@]} -gt 0 ]; then
        echo
        print_warning "Some runtimes failed to build. Please check the errors above."
        return 1
    fi
    
    # Success message and next steps
    echo
    print_success "All runtimes built successfully!"
    echo
    echo -e "${CYAN}${BUILD} Next steps:${NC}"
    echo "  1. Review the generated files"
    echo "  2. Commit and push to GitHub:"
    echo "     git add runtimes/*.tar.gz runtimes/runtime-manifest.json"
    echo "     git commit -m 'Build runtime packages and update manifest'"
    echo "     git push"
    echo
    echo "  3. Users can then install runtimes with:"
    echo "     rnx runtime install <runtime-name> --github-repo=owner/repo/tree/main/runtimes"
    
    return 0
}

# Run main function
main "$@"