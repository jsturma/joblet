#!/bin/bash
set -e

echo "Installing runtime {{.RuntimeSpec}} from GitHub repository {{.Repository}}"
cd /tmp
rm -rf runtime-build

# Download and validate runtime using manifest system
MANIFEST_URL="https://github.com/{{.Repository}}/raw/{{.Branch}}/{{.Path}}/runtime-manifest.json"
RUNTIME_NAME="{{.RuntimeSpec}}"

echo "ðŸ” Checking runtime manifest for '{{.RuntimeSpec}}'..."
echo "  Manifest URL: $MANIFEST_URL"

# Download runtime manifest
if ! wget -q "$MANIFEST_URL" -O manifest.json; then
    echo ""
    echo "âŒ ERROR: Could not download runtime manifest"
    echo ""
    echo "The repository does not contain a runtime manifest at:"
    echo "  $MANIFEST_URL"
    echo ""
    echo "This repository may not support the new manifest-based runtime system."
    echo "Repository maintainers: Please create a runtime-manifest.json file."
    echo "See: https://github.com/{{.Repository}}/blob/{{.Branch}}/{{.Path}}/README.md"
    exit 1
fi

echo "âœ… Runtime manifest downloaded successfully"

# Extract runtime information from manifest (basic shell JSON parsing)
# Check if runtime exists in manifest
if ! grep -q "\"$RUNTIME_NAME\":" manifest.json; then
    echo ""
    echo "âŒ ERROR: Runtime '$RUNTIME_NAME' not found in manifest"
    echo ""
    echo "Available runtimes in this repository:"
    # Extract runtime names from manifest
    grep -o '\"[^\"]*\":' manifest.json | grep -v '\"version\|\"generated\|\"repository\|\"base_url\|\"platforms\|\"supported\|\"archive_url\|\"archive_size\|\"checksum\|\"min_ram_mb\|\"min_disk_mb\|\"gpu_required\|\"executables\|\"libraries\|\"environment_vars\|\"usage\|\"examples\|\"name\|\"display_name\|\"description\|\"category\|\"language\|\"requirements\|\"provides\|\"documentation\|\"tags\"' | sed 's/[\":]*//g' | sort -u | sed 's/^/  â€¢ /'
    echo ""
    echo "Use 'rnx runtime list --github-repo={{.Repository}}' to see detailed runtime information."
    rm -f manifest.json
    exit 1
fi

# Detect current platform
DETECTED_OS="unknown"
DETECTED_ARCH="unknown"

# Detect OS
if [ -f /etc/os-release ]; then
    . /etc/os-release
    case "$ID" in
        ubuntu|debian) DETECTED_OS="ubuntu" ;;
        rhel|centos|rocky|almalinux) DETECTED_OS="rhel" ;;
        amzn) DETECTED_OS="amzn" ;;
        *) DETECTED_OS="$ID" ;;
    esac
fi

# Detect architecture
case "$(uname -m)" in
    x86_64) DETECTED_ARCH="amd64" ;;
    aarch64|arm64) DETECTED_ARCH="arm64" ;;
    *) DETECTED_ARCH="$(uname -m)" ;;
esac

PLATFORM_KEY="${DETECTED_OS}-${DETECTED_ARCH}"
echo "ðŸ–¥ï¸  Detected platform: $PLATFORM_KEY"

# Check if runtime supports this platform
PLATFORM_SUPPORTED=$(grep -A 20 "\"$RUNTIME_NAME\":" manifest.json | grep -A 10 '"platforms":' | grep -A 3 "\"$PLATFORM_KEY\":" | grep '"supported"' | grep -o 'true\|false' | head -1)

if [ "$PLATFORM_SUPPORTED" != "true" ]; then
    echo ""
    echo "âŒ ERROR: Runtime '$RUNTIME_NAME' does not support platform '$PLATFORM_KEY'"
    echo ""
    echo "Supported platforms for '$RUNTIME_NAME':"
    grep -A 20 "\"$RUNTIME_NAME\":" manifest.json | grep -A 10 '"platforms":' | grep '":' | grep -v '"platforms":' | sed 's/.*"\([^"]*\)".*/  â€¢ \1/' | head -10
    echo ""
    echo "Your platform: $PLATFORM_KEY"
    rm -f manifest.json
    exit 1
fi

echo "âœ… Platform compatibility confirmed"

# Extract archive URL and size
ARCHIVE_URL=$(grep -A 20 "\"$RUNTIME_NAME\":" manifest.json | grep -A 10 '"platforms":' | grep -A 5 "\"$PLATFORM_KEY\":" | grep '"archive_url"' | head -1 | sed 's/.*"archive_url":[[:space:]]*"\([^"]*\)".*/\1/')
ARCHIVE_SIZE=$(grep -A 20 "\"$RUNTIME_NAME\":" manifest.json | grep -A 10 '"platforms":' | grep -A 5 "\"$PLATFORM_KEY\":" | grep '"archive_size"' | head -1 | sed 's/.*"archive_size":[[:space:]]*\([0-9]*\).*/\1/')

if [ -z "$ARCHIVE_URL" ]; then
    echo "âŒ ERROR: Could not determine archive URL from manifest"
    rm -f manifest.json
    exit 1
fi

FULL_ARCHIVE_URL="https://github.com/{{.Repository}}/raw/{{.Branch}}/{{.Path}}/$ARCHIVE_URL"
echo "ðŸ“¦ Archive URL: $FULL_ARCHIVE_URL"
echo "ðŸ“Š Archive size: $ARCHIVE_SIZE bytes"

# Download and extract the runtime archive
echo "ðŸ“¦ Downloading runtime archive..."

# First try to download with verbose error reporting
echo "ðŸŒ Using wget to download from: $FULL_ARCHIVE_URL"
if wget -L -v "$FULL_ARCHIVE_URL" -O runtime.tar.gz 2>&1; then
    echo "âœ… Download successful"
    
    # Check if file was actually downloaded and has content
    if [ ! -f runtime.tar.gz ] || [ ! -s runtime.tar.gz ]; then
        echo "âŒ ERROR: Downloaded file is empty or missing"
        ls -la runtime.tar.gz 2>/dev/null || echo "  File does not exist"
        rm -f runtime.tar.gz manifest.json
        exit 1
    fi
    
    echo "ðŸ“Š Downloaded file size: $(stat -c%%s runtime.tar.gz 2>/dev/null || echo 'unknown') bytes"
    
    # Create extraction directory and extract
    echo "ðŸ“‚ Creating extraction directory..."
    if mkdir -p runtime-build; then
        echo "ðŸ—œï¸  Extracting archive..."
        if tar -xzf runtime.tar.gz -C runtime-build 2>&1; then
            echo "âœ… Successfully extracted runtime archive"
            rm -f runtime.tar.gz manifest.json
            DOWNLOAD_SUCCESS=true
        else
            echo "âŒ ERROR: Failed to extract archive"
            echo "  Archive may be corrupted"
            file runtime.tar.gz 2>/dev/null || echo "  Cannot determine file type"
            rm -f runtime.tar.gz manifest.json
            exit 1
        fi
    else
        echo "âŒ ERROR: Failed to create extraction directory"
        rm -f runtime.tar.gz manifest.json
        exit 1
    fi
else
    echo "âŒ ERROR: wget download failed"
    echo "  Archive URL: $FULL_ARCHIVE_URL"
    echo "  Debugging info:"
    echo "    - Testing basic connectivity..."
    wget --spider --timeout=10 "https://github.com" 2>&1 || echo "    - No GitHub connectivity"
    echo "    - Checking if URL is reachable..."
    wget --spider --timeout=10 "$FULL_ARCHIVE_URL" 2>&1 || echo "    - URL not reachable"
    rm -f runtime.tar.gz manifest.json
    exit 1
fi

# Navigate to the correct directory
# If we downloaded a pre-packaged ZIP, files are directly in runtime-build/
# If we downloaded the full repo, navigate to the runtime subdirectory
if [ -f runtime-build/setup.sh ] || [ -f runtime-build/install.sh ]; then
    echo "Runtime files found directly in runtime-build/"
    cd runtime-build
elif [ -d "runtime-build/{{.Path}}" ]; then
    echo "Navigating to runtime-build/{{.Path}}"
    cd "runtime-build/{{.Path}}"
elif [ -d "runtime-build/{{.RuntimeSpec}}/{{.Path}}" ]; then
    echo "Navigating to runtime-build/{{.RuntimeSpec}}/{{.Path}}"
    cd "runtime-build/{{.RuntimeSpec}}/{{.Path}}"
else
    echo "ERROR: Could not find runtime files in expected locations"
    echo "Checked: runtime-build/, runtime-build/{{.Path}}, runtime-build/{{.RuntimeSpec}}/{{.Path}}"
    ls -la runtime-build/ 2>/dev/null || true
    exit 1
fi

# Execute the setup script
if [ -f setup.sh ]; then
    chmod +x setup.sh
    echo "Executing setup.sh..."
    ./setup.sh
elif [ -f install.sh ]; then
    chmod +x install.sh
    echo "Executing install.sh..."
    ./install.sh
else
    echo "ERROR: No setup.sh or install.sh found in current directory"
    ls -la
    exit 1
fi

echo "Runtime {{.RuntimeSpec}} installation completed"