syntax = "proto3";

option go_package = "github.com/ehsaniara/joblet/internal/proto/gen/persist";

package joblet.persist;

// PersistService is an INTERNAL service for joblet-core ←→ joblet-persist IPC communication.
//
// ⚠️  DO NOT USE DIRECTLY - This service is for internal communication only via Unix socket.
//
// Public API: Use JobService.QueryLogs() and JobService.QueryMetrics()
//             These methods proxy to this internal service automatically.
//
// This service is provided by joblet-persist subprocess and communicates via Unix socket IPC.
service PersistService {
  // Health check - verify persist is running and responsive
  rpc Ping(PingRequest) returns (PingResponse);

  // Query logs for a job from disk storage
  rpc QueryLogs(QueryLogsRequest) returns (stream LogLine);

  // Query metrics for a job from disk storage
  rpc QueryMetrics(QueryMetricsRequest) returns (stream Metric);

  // Delete all persisted data for a job (admin only)
  rpc DeleteJob(DeleteJobRequest) returns (DeleteJobResponse);
}

// PingRequest is a health check request (empty)
message PingRequest {}

// PingResponse indicates persist is healthy and responsive
message PingResponse {
  bool healthy = 1;
  int64 timestamp = 2;  // Unix nanoseconds when ping was processed
}

// QueryLogsRequest specifies parameters for log queries
message QueryLogsRequest {
  string job_id = 1;

  // Stream filter
  StreamType stream = 2;  // STDOUT, STDERR, or both (UNSPECIFIED)

  // Time range (optional)
  int64 start_time = 3;  // Unix nanoseconds
  int64 end_time = 4;    // Unix nanoseconds

  // Pagination
  int32 limit = 5;       // Max lines to return (0 = all)
  int32 offset = 6;      // Skip lines
}

// QueryMetricsRequest specifies parameters for metrics queries
message QueryMetricsRequest {
  string job_id = 1;

  // Time range (optional)
  int64 start_time = 2;  // Unix nanoseconds
  int64 end_time = 3;    // Unix nanoseconds

  // Pagination
  int32 limit = 4;       // Max samples to return (0 = all)
  int32 offset = 5;      // Skip samples
}

// LogLine represents a single log line from a job
message LogLine {
  string job_id = 1;
  StreamType stream = 2;     // stdout or stderr
  int64 timestamp = 3;       // Unix nanoseconds
  uint64 sequence = 4;       // Sequence number
  bytes content = 5;         // Log line content
}

// StreamType indicates stdout or stderr
enum StreamType {
  STREAM_TYPE_UNSPECIFIED = 0;
  STREAM_TYPE_STDOUT = 1;
  STREAM_TYPE_STDERR = 2;
}

// Metric represents a metrics sample from a job
message Metric {
  string job_id = 1;
  int64 timestamp = 2;       // Unix nanoseconds
  uint64 sequence = 3;       // Sequence number
  MetricData data = 4;       // Metric values
}

// MetricData contains the actual metric values
message MetricData {
  double cpu_usage = 1;           // CPU usage (0.0 - cores)
  int64 memory_usage = 2;         // Memory usage in bytes
  double gpu_usage = 3;           // GPU usage (0.0 - 1.0)
  DiskIO disk_io = 4;             // Disk I/O statistics
  NetworkIO network_io = 5;       // Network I/O statistics
}

// DiskIO represents disk I/O statistics
message DiskIO {
  int64 read_bytes = 1;
  int64 write_bytes = 2;
  int64 read_ops = 3;
  int64 write_ops = 4;
}

// NetworkIO represents network I/O statistics
message NetworkIO {
  int64 rx_bytes = 1;
  int64 tx_bytes = 2;
  int64 rx_packets = 3;
  int64 tx_packets = 4;
}

// DeleteJobRequest specifies the job to delete from persist storage
message DeleteJobRequest {
  string job_id = 1;
}

// DeleteJobResponse indicates the result of the deletion
message DeleteJobResponse {
  bool success = 1;
  string message = 2;
}
