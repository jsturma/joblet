#!/bin/bash
set -e

case "$1" in
    remove)
        # Clean up cgroup directories
        if [ -d "/sys/fs/cgroup/joblet.slice" ]; then
            find /sys/fs/cgroup/joblet.slice -name "job-*" -type d -exec rmdir {} \; 2>/dev/null || true
        fi

        # Remove systemd log directory
        rm -rf /var/log/joblet

        # Remove symlinks
        rm -f /usr/bin/joblet
        rm -f /usr/bin/rnx
        rm -f /usr/local/bin/rnx
        rm -f /usr/local/bin/certs_gen_embedded.sh

        # Remove user-accessible certificate symlinks
        rm -rf /etc/joblet

        # Note: Job logs in /opt/joblet/logs are preserved
        # Use 'apt purge joblet' to remove all data including job logs
        if [ -d "/opt/joblet/logs" ] && [ "$(ls -A /opt/joblet/logs 2>/dev/null)" ]; then
            echo "Note: Job logs preserved in /opt/joblet/logs"
            echo "Use 'apt purge joblet' to remove all data"
        fi

        echo "Joblet service removed successfully!"
        ;;

    purge)
        # Remove user and all data on purge
        if id joblet >/dev/null 2>&1; then
            userdel joblet 2>/dev/null || true
        fi

        # Count log files before removal
        LOG_COUNT=0
        if [ -d "/opt/joblet/logs" ]; then
            LOG_COUNT=$(find /opt/joblet/logs -name "*.log" -type f 2>/dev/null | wc -l)
        fi

        # Remove all joblet files including job logs, volumes, and configuration
        rm -rf /opt/joblet
        rm -rf /var/log/joblet
        rm -rf /etc/joblet

        # Remove symlinks
        rm -f /usr/bin/joblet
        rm -f /usr/bin/rnx
        rm -f /usr/local/bin/rnx
        rm -f /usr/local/bin/certs_gen_embedded.sh

        if [ "$LOG_COUNT" -gt 0 ]; then
            echo "Removed $LOG_COUNT job log files"
        fi
        echo "Joblet service purged successfully!"
        ;;
esac

exit 0