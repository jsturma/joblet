# Test environment variables flowing through workflow dependencies
environment:
  PIPELINE_ID: "dep-test-001"
  SHARED_CONFIG: "global-config-value"

secret_environment:
  PIPELINE_SECRET: "global-pipeline-secret"

jobs:
  setup:
    command: "sh"
    args: [ "-c", "echo 'Setup completed for ${PIPELINE_ID}' && echo 'Config: ${SHARED_CONFIG}' && echo 'Setup stage: ${STAGE}'" ]
    environment:
      STAGE: "setup"
      SETUP_DIR: "/tmp/${PIPELINE_ID}/setup"
    secret_environment:
      SETUP_SECRET: "setup-stage-secret"

  process:
    command: "sh"
    args: [ "-c", "echo 'Processing ${PIPELINE_ID}' && echo 'Previous stage was: ${PREV_STAGE}' && echo 'Current stage: ${STAGE}' && echo 'Work dir: ${WORK_DIR}'" ]
    requires:
      - setup: "COMPLETED"
    environment:
      STAGE: "processing"
      PREV_STAGE: "setup"  # Manual reference (in real scenarios could be templated)
      WORK_DIR: "/tmp/${PIPELINE_ID}/process"
      SHARED_CONFIG: "process-override-config"  # Override global
    secret_environment:
      PROCESS_SECRET: "process-stage-secret"

  finalize:
    command: "sh"
    args: [ "-c", "echo 'Finalizing ${PIPELINE_ID}' && echo 'Final stage: ${STAGE}' && echo 'Output dir: ${OUTPUT_DIR}' && echo 'All secrets available'" ]
    requires:
      - process: "COMPLETED"
    environment:
      STAGE: "finalize"
      OUTPUT_DIR: "/tmp/${PIPELINE_ID}/output"
    secret_environment:
      FINAL_SECRET: "final-stage-secret"