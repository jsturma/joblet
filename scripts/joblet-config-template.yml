# Unified Joblet Configuration
# This file configures both joblet (main service) and joblet-persist (persistence service)

version: "3.0"

# ============================================================================
# JOBLET MAIN SERVICE CONFIGURATION
# ============================================================================

server:
  address: "0.0.0.0"
  port: 50051
  mode: "server"
  timeout: "10s"
  nodeId: ""  # Will be generated during setup

joblet:
  defaultCpuLimit: 0            # No CPU limit by default (0 = unlimited)
  defaultMemoryLimit: 0         # No memory limit by default (0 = unlimited)
  defaultIoLimit: 0             # No I/O limit by default (0 = unlimited)
  maxConcurrentJobs: 0          # No job concurrency limit (0 = unlimited)
  jobTimeout: "0s"              # No job timeout by default (0 = unlimited)
  cleanupTimeout: "100ms"       # Fast cleanup for performance

cgroup:
  baseDir: "/sys/fs/cgroup/joblet.slice/joblet.service"
  namespaceMount: "/sys/fs/cgroup"
  enableControllers: [ "memory", "cpu", "io", "pids", "cpuset", "devices" ]
  cleanupTimeout: "100ms"       # Fast cgroup cleanup for performance

# GPU support configuration
gpu:
  enabled: false               # Enable GPU support (off by default - opt-in only)
  cuda_paths: # CUDA installation paths to search
    - "/usr/local/cuda"
    - "/opt/cuda"

network:
  state_dir: "/opt/joblet/network"
  enabled: true
  default_network: "bridge"
  allow_custom_networks: true
  max_custom_networks: 0       # No limit on custom networks (0 = unlimited)
  # Network storage configuration - file-based persistence
  storage:
    path: "/opt/joblet/network"  # Directory for network state files
  networks:
    bridge:
      cidr: "172.20.0.0/16"
      bridge_name: "joblet0"

filesystem:
  baseDir: "/opt/joblet/jobs"
  tmpDir: "/tmp/job-{JOB_ID}"
  workspaceDir: "/work"         # Directory for job uploads and execution
  allowedMounts:
    - "/usr/bin"
    - "/bin"
    - "/usr/sbin"               # Network tools (ip, route, etc.)
    - "/lib"
    - "/lib64"
    - "/usr/lib"
    - "/usr/lib64"
    # Network configuration files
    - "/etc/resolv.conf"        # DNS resolver configuration
    - "/etc/hosts"              # Local hostname resolution
    - "/etc/nsswitch.conf"      # Name service switch configuration
    # SSL certificate directories
    - "/etc/ssl"
    - "/etc/pki"
    - "/etc/ca-certificates"
    - "/usr/share/ca-certificates"
  blockDevices: false

grpc:
  # Production-grade gRPC settings for high-performance traffic
  maxRecvMsgSize: 134217728        # 128MB - handle large file uploads/downloads
  maxSendMsgSize: 134217728        # 128MB - handle large responses and streaming
  maxHeaderListSize: 16777216      # 16MB - handle large metadata/headers
  keepAliveTime: "10s"             # More frequent keepalives for connection health
  keepAliveTimeout: "3s"           # Faster timeout detection
  maxConcurrentStreams: 1000       # High concurrent stream limit
  connectionTimeout: "10s"         # Connection establishment timeout
  maxConnectionIdle: "300s"        # 5min idle before cleanup
  maxConnectionAge: "1800s"        # 30min max connection lifetime
  maxConnectionAgeGrace: "30s"     # Grace period for connection shutdown

logging:
  level: "INFO"
  format: "text"
  output: "stdout"

# Buffer configuration for pub-sub live streaming
buffers:
  pubsub_buffer_size: 10000   # Pub-sub channel buffer for high-throughput production traffic
  chunk_size: 1048576         # 1MB chunks for optimal streaming performance

# IPC configuration for joblet-persist integration
# IMPORTANT: This setting controls BOTH persistence AND buffering behavior:
#   enabled: true  - Logs/metrics buffered in memory + forwarded to persist (gap prevention enabled)
#   enabled: false - NO buffering (live streaming only, no persistence, no historical data)
# Disabling persist eliminates unbounded memory growth but loses historical log/metric access
ipc:
  enabled: true                                   # Enable IPC to persist service + in-memory buffering
  socket: "/opt/joblet/run/persist-ipc.sock"      # Unix socket for log/metric writes
  buffer_size: 10000                              # Message buffer size
  reconnect_delay: "5s"                           # Reconnection retry delay
  max_reconnects: 0                               # Max reconnection attempts (0 = infinite)

# Volume management configuration
volumes:
  base_path: "/opt/joblet/volumes"  # Base directory for all volumes
  default_disk_quota_bytes: 1048576  # Default disk quota for jobs without volumes (1MB)

monitoring:
  enabled: true
  system_interval: "10s"
  cloud_detection: true

# Runtime System Configuration
runtime:
  base_path: "/opt/joblet/runtimes"
  common_paths:
    - "/usr/local/bin"
    - "/usr/local/lib"
    - "/usr/lib/jvm"
    - "/usr/local/node"
    - "/usr/local/go"

# Security section will be added by certs_gen_embedded.sh
# DO NOT ADD CERTIFICATES HERE - they will be embedded automatically

# ============================================================================
# JOBLET-PERSIST SERVICE CONFIGURATION
# Persistence service runs as subprocess and INHERITS parent configurations:
#   - logging (level, format, output)
#   - security (TLS certificates)
#   - base paths
#
# Persist can OVERRIDE specific settings while inheriting the rest
# ============================================================================

persist:
  server:
    grpc_socket: "/opt/joblet/run/persist-grpc.sock"  # Unix socket for gRPC queries (TCP disabled)
    max_connections: 500       # Override: Different connection limit
    # TLS: Disabled for Unix socket (pure Linux IPC)

  ipc:
    socket: "/opt/joblet/run/persist-ipc.sock"  # Unix socket for log/metric writes
    max_connections: 10
    max_message_size: 134217728  # 128MB - handle large batches
    read_buffer: 8388608         # 8MB
    write_buffer: 8388608        # 8MB

  storage:
    # Storage backend type: "local", "cloudwatch", or "s3"
    # Auto-detection: When installed on EC2, the installer can set this to "cloudwatch"
    type: "local"

    # LOCAL storage configuration (filesystem-based)
    local:
      logs:
        directory: "/opt/joblet/logs"      # Inherited from parent's log dir
        format: "jsonl"                     # Gzip compressed JSON lines

      metrics:
        directory: "/opt/joblet/metrics"   # Inherited from parent's metrics dir
        format: "jsonl.gz"                  # Gzip compressed JSON lines

    # AWS CLOUDWATCH storage configuration (cloud-native)
    # Automatically configured when running on EC2 instances
    # Log groups organized by node: {log_group_prefix}/{nodeId}/jobs/{jobId}
    #
    # AUTHENTICATION: Uses AWS default credential chain (secure, no credentials in config)
    #   1. IAM Role / Instance Profile (recommended for EC2)
    #   2. Environment variables (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY)
    #   3. Shared credentials file (~/.aws/credentials)
    #
    cloudwatch:
      region: ""                              # AWS region (empty = auto-detect from EC2 metadata)
      log_group_prefix: "/joblet"             # CloudWatch Logs group prefix (nodeId automatically inserted)
      log_stream_prefix: "job-"               # CloudWatch Logs stream prefix
      metric_namespace: "Joblet/Jobs"         # CloudWatch Metrics namespace
      metric_dimensions:                      # Additional metric dimensions (optional)
      # Environment: "production"
      # Cluster: "main"

      # Batch settings for CloudWatch API
      log_batch_size: 100                     # Max log events per batch (CloudWatch limit: 10,000)
      metric_batch_size: 20                   # Max metric data points per batch (CloudWatch limit: 1,000)

      # Log retention settings (controls storage costs)
      log_retention_days: 7                   # Log retention in days (default: 7)
      # Valid values: 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653
      # 0 or not set = default to 7 days
      # -1 = never expire (infinite retention - expensive!)
      #
      # Cost optimization examples:
      #   log_retention_days: 1    # Development (minimal storage cost)
      #   log_retention_days: 7    # Default (balanced)
      #   log_retention_days: 30   # Production (standard)
      #   log_retention_days: 365  # Compliance (1 year)
      #   log_retention_days: -1   # Never expire (not recommended)
